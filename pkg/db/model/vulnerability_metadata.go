package model

import (
	"database/sql"
	"encoding/json"
	"fmt"

	"github.com/anchore/grype-db/pkg/db"
)

const (
	VulnerabilityMetadataTableName = "vulnerability_metadata"
)

// VulnerabilityMetadataModel is a struct used to serialize db.VulnerabilityMetadata information into a sqlite3 DB.
type VulnerabilityMetadataModel struct {
	ID           string         `gorm:"primary_key; column:id;"`
	RecordSource string         `gorm:"primary_key; column:record_source;"`
	Severity     string         `gorm:"column:severity"`
	Links        string         `gorm:"column:links"`
	Description  string         `gorm:"column:description"`
	Cvss         sql.NullString `gorm:"column:cvss"`
}

// NewVulnerabilityMetadataModel generates a new model from a db.VulnerabilityMetadata struct.
func NewVulnerabilityMetadataModel(metadata db.VulnerabilityMetadata) VulnerabilityMetadataModel {
	links, err := json.Marshal(metadata.Links)
	if err != nil {
		// TODO: just no
		panic(err)
	}

	var cvssStr sql.NullString
	if metadata.Cvss != nil {
		cvss, err := json.Marshal(metadata.Cvss)
		if err != nil {
			// TODO: just no
			panic(err)
		}
		cvssStr.String = string(cvss)
		cvssStr.Valid = true
	}

	return VulnerabilityMetadataModel{
		ID:           metadata.ID,
		RecordSource: metadata.RecordSource,
		Severity:     metadata.Severity,
		Links:        string(links),
		Description:  metadata.Description,
		Cvss:         cvssStr,
	}
}

// TableName returns the table which all db.VulnerabilityMetadata model instances are stored into.
func (VulnerabilityMetadataModel) TableName() string {
	return VulnerabilityMetadataTableName
}

// Inflate generates a db.VulnerabilityMetadataModel object from the serialized model instance.
func (m *VulnerabilityMetadataModel) Inflate() (db.VulnerabilityMetadata, error) {
	var links []string
	var cvss []db.Cvss

	if err := json.Unmarshal([]byte(m.Links), &links); err != nil {
		return db.VulnerabilityMetadata{}, fmt.Errorf("unable to unmarshal links (%+v): %w", m.Links, err)
	}

	if m.Cvss.Valid {
		err := json.Unmarshal([]byte(m.Cvss.String), &cvss)
		if err != nil {
			return db.VulnerabilityMetadata{}, fmt.Errorf("unable to unmarshal cvss data (%+v): %w", m.Cvss, err)
		}
	}

	return db.VulnerabilityMetadata{
		ID:           m.ID,
		RecordSource: m.RecordSource,
		Severity:     m.Severity,
		Links:        links,
		Description:  m.Description,
		Cvss:         cvss,
	}, nil
}
