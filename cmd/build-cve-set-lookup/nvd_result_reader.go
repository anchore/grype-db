package main

import (
	"database/sql"
	"encoding/json"
	"github.com/anchore/grype-db/pkg/provider/unmarshal/nvd"
	"github.com/facebookincubator/nvdtools/wfn"
	"strings"
)

type resultRecordEnvelope struct {
	Item nvd.Vulnerability `json:"item"`
}

func readCpeToVendorProduct(db *sql.DB) (cveToVendorProduct map[string][]string) {
	cveToVendorProduct = map[string][]string{}

	query := panget(db.Prepare("select record from results"))
	rows := panget(query.Query())

	for rows.Next() {
		var record string
		logif(rows.Scan(&record))
		var row resultRecordEnvelope
		logif(json.Unmarshal([]byte(record), &row))

		cve := row.Item.Cve
		cveId := normalizeCve(cve.ID)

		cveToVendorProduct[cveId] = append(cveToVendorProduct[cveId], extractVendorProducts(cve)...)
	}

	return cveToVendorProduct
}

func extractVendorProducts(cve nvd.CveItem) []string {
	var out []string
	for _, conf := range cve.Configurations {
		for _, node := range conf.Nodes {
			for _, cpeMatch := range node.CpeMatch {
				w, err := wfn.Parse(cpeMatch.Criteria)
				if err == nil && w != nil {
					out = append(out, toVendorProduct(w))
				}
			}
		}
	}
	if len(out) > 1 {
		// don't include results when multiple different softwares are identified in a CVE
		return nil
	}
	return out
}

func normalizeCve(cve string) string {
	return strings.ToLower(cve)
}
